name: Build Web Docs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Detect Godot source changes
      - name: Check for Godot source changes
        id: godot_changes
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep -E 'SConstruct|modules/|core/|servers/'; then
            echo "godot_changed=true" >> $GITHUB_OUTPUT
          else
            echo "godot_changed=false" >> $GITHUB_OUTPUT
          fi

      # 3. Cache Godot build artifacts
      - name: Cache Godot build
        uses: actions/cache@v3
        with:
          path: |
            .scons
            bin/
          key: godot-build-${{ hashFiles('**/SConstruct') }}

      # 4. Download prebuilt Godot if there are changes
      - name: Download Godot prebuilt
        if: steps.godot_changes.outputs.godot_changed == 'true'
        run: |
          mkdir -p ./bin
          curl -L -o godot.zip https://github.com/godotengine/godot/releases/download/4.3.2/Godot_v4.3.2-stable_linux.headless.64.zip
          unzip -o godot.zip -d ./bin || echo "Download failed, will build from source"

      # 5. Build Godot from source if needed
      - name: Build Godot from source
        if: steps.godot_changes.outputs.godot_changed == 'true'
        run: |
          if [ ! -f ./bin/Godot_v4.3.2-stable_linux.headless.64 ]; then
            echo "Prebuilt Godot not found, building from source..."
            scons -j$(nproc) platform=web tools=no target=release_debug
          else
            echo "Prebuilt Godot exists, skipping build."
          fi

      # 6. Build Web Project
      - name: Build Web Project
        run: |
          npm ci
          npm run build

      # 7. Build Documentation
      - name: Build Documentation
        run: make html

      # 8. Deploy to GitHub Pages
      - name: Deploy Docs
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          clean: true
